#!/usr/bin/python3

import re
import os
import argparse
import sys
import traceback
import requests
from requests.packages import urllib3

# ignore InsecureRequestWarning warnings when skipping TLS certificate verification
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def download_course(auth_cookie, course_url, output_dir, dry_run=False):
    if not os.path.isdir(output_dir):
        print(f"[!] Output directory doesn't exist")
        sys.exit(1)
    else:
        if output_dir[-1] == '/':
            output_dir = output_dir[:-1]

    print(f"[+] Using URL: {course_url}")
    print(f"[+] Using cookie: {auth_cookie}")
    print(f"[+] Using output directory: {output_dir}")

    response = requests.get(course_url, verify=False)
    content = response.content.decode()
    videoList = re.findall(r'(\/getstats\?videoid=[0-9]*)', content)

    cookie = 'SACSID=' + auth_cookie

    for index, video in enumerate(videoList):
        output_video_id = index + 1

        video = str(video)
        video = video.replace(
            'getstats', 'accounting').replace("videoid", "id")
        video_url = f"https://www.pentesteracademy.com{video}"

        print(f"\n[+] Found video: {video_url}")

        output_video_filename = f"{output_dir}/video_{output_video_id}.mp4"

        if os.path.isfile(output_video_filename):
            print(
                f"[!] File {output_video_filename} already exists. Checking the next one...")
            continue

        try:
            print(f'[+] Sending request for video {output_video_id}/{len(videoList)}')

            if not dry_run:
                headers = {
                    'Cookie': cookie
                }
                with requests.get(video_url, headers=headers, verify=False, stream=True) as r:
                    with open(output_video_filename, 'wb') as f:
                        for chunk in r.iter_content(chunk_size=128):
                            f.write(chunk)
        except:
            print(f"[!] An error occured while downloading the video")
            traceback.print_exc()
            sys.exit(1)

        if os.path.isfile(output_video_filename) or dry_run:
            print(
                f'[+] Video n. {output_video_id} saved at {output_video_filename}')
        else:
            print(
                f"[!] File {output_video_filename} not saved. Something weird happened")
            print(
                f"[!] Please check the code or the status or the server. Quitting ...")
            sys.exit(1)


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument(
        'course_url', help='URL of the course you wish to download (e.g. https://www.pentesteracademy.com/course?id=3')
    parser.add_argument(
        'cookie', help='Cookie you get after authenticating through Google')
    parser.add_argument(
        'output_dir', help='Output directory where videos are saved')
    parser.add_argument(
        '--dry-run', help='Test without downloading (not consuming plays)', default=False, action='store_true')

    if len(sys.argv) == 1:
        parser.print_help()
        sys.exit(1)

    args = parser.parse_args()

    course_url = args.course_url
    cookie = args.cookie
    output_dir = args.output_dir
    dry_run = args.dry_run

    download_course(auth_cookie=cookie, course_url=course_url,
                    output_dir=output_dir, dry_run=dry_run)


if __name__ == '__main__':
    main()
